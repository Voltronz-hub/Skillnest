<!DOCTYPE html>
<html>
<head>
  <title>SkillNest - Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/style.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/chat.js"></script>
  <script>
    (function(){
      const jobId = '<%= jobId %>';
      const userId = '<%= userId %>';
      function renderMessage(m) {
        const who = m.sender || 'Unknown';
        const time = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
        const attachments = m.attachments && m.attachments.length ? m.attachments.map(a => `<div><a href="${a.path}" target="_blank">${a.filename}</a></div>`).join('') : '';
        return `<div class='mb-2'><div><span class='fw-bold text-primary'>${who}</span> <small class='text-muted'>${time}</small></div><div>${m.message || ''}</div>${attachments}</div>`;
      }

      const chatEl = document.getElementById('chat');
      window.ChatClient && window.ChatClient.joinRoom({ jobId, userId });
      window.ChatClient && window.ChatClient.on('recentMessages', function(list){ list.forEach(m => { chatEl.innerHTML += renderMessage(m); }); chatEl.scrollTop = chatEl.scrollHeight; });
      window.ChatClient && window.ChatClient.on('chatMessage', function(m){ chatEl.innerHTML += renderMessage(m); chatEl.scrollTop = chatEl.scrollHeight; });
      window.sendMessage = function(){ const input = document.getElementById('msg'); const msg = input.value.trim(); if (!msg) return; window.ChatClient && window.ChatClient.sendMessage({ jobId, userId, message: msg }); input.value=''; };
    })();
  </script>
</head>
<body class="bg-light">
  <%- include('partials/navbar') %>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="mb-4">Job Chat</h2>
            <div id="chat" class="mb-3" style="min-height:200px;"></div>
            <div class="mb-2">
              <form id="uploadForm" method="POST" action="/chat/<%= jobId %>/upload" enctype="multipart/form-data" class="d-flex gap-2">
                <input type="file" name="attachment" class="form-control form-control-sm" />
                <input type="text" name="message" class="form-control form-control-sm" placeholder="Add an optional note for the file" />
                <button class="btn btn-outline-secondary btn-sm" type="submit">Upload</button>
              </form>
            </div>
            <div class="input-group">
              <input type="text" id="msg" class="form-control" placeholder="Type a message">
              <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <%- include('partials/footer') %>
</body>
</html>
